<html><head><meta charset="utf-8">
<script src="promjs.js"></script>
<script>

async function fetchAsync (url) {
  let response = await fetch(url);
  let data = await response.json();
  return data;
}

/*
    gopherjs serve
    then view at http://localhost:8080/github.com/prometheus/prometheus/promjs/
*/

function demo(hours) {
  let p = promCache.New()

  let prometheus = "http://192.168.99.100:30090"
  let metric = "scrape_duration_seconds"
  if ("undefined" == typeof(hours)) {
    hours = 1
  }

  fetchAsync(`${prometheus}/api/v1/query?query=${metric}[${hours}h]`).then(function(d){
    let start = performance.now()

    p.SetMetrics(d.data.result)

    // warning "mode" with different threshold, severity, and confidence parameters:
    p.SetModel(
      `${metric}{monitor_type=""} >= bool 0.1`,
      {
        "__name__":  "model",
        "name":      metric,
        "threshold": "0.1",
      },
      "warning")
    p.SetHealth(
      `(avg_over_time(model{name="${metric}",monitor_type="",threshold="0.1"}[10m]) >=bool 0.3) * 2`,
      {
        "__name__": "health",
        "severity": "warning",
        "window":   "10m",
      },
      "warning")

    // critical "mode" with different threshold, severity, and confidence parameters:
    p.SetModel(
      `${metric}{monitor_type=""} >= bool 0.1`,
      {
        "__name__":  "model",
        "name":      metric,
        "threshold": "0.5",
      },
      "critical")
    p.SetHealth(
      `(avg_over_time(model{name="${metric}",monitor_type="",threshold="0.5"}[10m]) >=bool 1) * 4`,
      {
        "__name__": "health",
        "severity": "critical",
        "window":   "10m",
      },
      "critical")

    let setup = Math.round(performance.now() - start)
    let res = p.InstantQuery("{__name__=~\".+\"}")
    let total = Math.round(performance.now() - start)

    console.log("millis:", total, "(", "setup:", setup, "instant query:", total-setup, ")" )
    console.log("result", res)
  })

  return p
}
</script>
</head>
<body>
</body>
</html>
